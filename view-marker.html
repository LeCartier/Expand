<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>QR Marker AR Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Three.js + AR.js for marker-based AR (experimental) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GLTF loader for .glb models -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>
    <!-- AR.js build that attaches classes to global `ARjs` rather than `THREEx` -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Central config -->
    <script src="config.js"></script>

    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        overflow: hidden;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #000;
        color: #e5e7eb;
      }
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 0.6rem 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to bottom, rgba(15,23,42,0.9), transparent);
        pointer-events: none;
        z-index: 10;
      }
      #overlay h1 {
        margin: 0;
        font-size: 0.95rem;
      }
      #overlay .status {
        font-size: 0.75rem;
        color: #9ca3af;
        text-align: right;
      }
      #backBtn {
        position: fixed;
        left: 0.7rem;
        bottom: 0.7rem;
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        border: none;
        background: rgba(15,23,42,0.9);
        color: #e5e7eb;
        font-size: 0.75rem;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        pointer-events: auto;
        z-index: 10;
      }
      #backBtn:hover {
        filter: brightness(1.1);
      }
    </style>
  </head>
  <body>
    <div id="overlay">
      <h1 id="title">Marker AR</h1>
      <div class="status" id="status">Point your camera at the printed QR code.</div>
    </div>
    <button id="backBtn" type="button">Back to viewer</button>

    <!-- AR.js video & debug containers to mirror examples -->
    <div id="arjs-video"></div>
    <div id="arjsDebugUIContainer"></div>

    <script>
      // Config from config.js
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.APP_CONFIG;
      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusEl = document.getElementById('status');
      const titleEl = document.getElementById('title');
      const backBtn = document.getElementById('backBtn');

      backBtn.addEventListener('click', () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id') || '';
        const url = id ? `view.html?id=${encodeURIComponent(id)}` : 'view.html';
        window.location.href = url;
      });

      function getIdFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('id');
        return raw ? raw.trim() : '';
      }

      async function loadModelMeta(qrId) {
        try {
          if (!qrId) {
            statusEl.textContent = 'Missing id parameter in URL.';
            return null;
          }
          statusEl.textContent = 'Looking up model info…';

          const { data, error } = await supabaseClient
            .from('qr_models')
            .select('name, glb_url, usdz_url')
            .eq('id', qrId)
            .maybeSingle();

          if (error) {
            console.error(error);
            statusEl.textContent = 'Failed to query Supabase.';
            return null;
          }
          if (!data) {
            statusEl.textContent = 'No model associated with this QR id.';
            return null;
          }
          const { name, glb_url, usdz_url } = data;
          titleEl.textContent = name || 'Marker AR';

          const src = glb_url || usdz_url;
          if (!src) {
            statusEl.textContent = 'No usable GLB/USDZ URL found.';
            return null;
          }

          return { name, src };
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Unexpected error loading model info.';
          return null;
        }
      }

      async function initMarkerExample() {
        const qrId = getIdFromQuery();
        const meta = await loadModelMeta(qrId);
        if (!meta) return;

        statusEl.textContent = 'Initializing marker-based AR…';

        // --- AR.js + Three.js marker example pattern ---
        const scene = new THREE.Scene();

        const ambientLight = new THREE.AmbientLight(0xffffff);
        scene.add(ambientLight);

        const camera = new THREE.Camera();
        scene.add(camera);

        const renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true,
        });
        renderer.setClearColor(new THREE.Color('black'), 0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.position = 'absolute';
        renderer.domElement.style.top = '0px';
        renderer.domElement.style.left = '0px';
        document.body.appendChild(renderer.domElement);

        const arToolkitSource = new ARjs.Source({
          sourceType: 'webcam',
        });

        function onResize() {
          arToolkitSource.onResizeElement();
          arToolkitSource.copyElementSizeTo(renderer.domElement);
          if (arToolkitContext.arController !== null) {
            arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
          }
        }

        arToolkitSource.init(function onReady() {
          onResize();
        });

        window.addEventListener('resize', () => {
          onResize();
        });

        const arToolkitContext = new ARjs.Context({
          cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/data/camera_para.dat',
          detectionMode: 'mono',
        });

        arToolkitContext.init(function onCompleted() {
          camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
          statusEl.textContent = 'Point your camera at the bullseye marker next to the QR.';
        });

        const markerRoot = new THREE.Group();
        scene.add(markerRoot);

        const markerControls = new ARjs.MarkerControls(arToolkitContext, markerRoot, {
          type: 'pattern',
          patternUrl: 'pattern-FFE+Letters+Only.patt',
        });

        // Group to hold the loaded model once ready
        const modelRoot = new THREE.Group();
        markerRoot.add(modelRoot);

        // Load the GLB model associated with this QR id
        const loader = new THREE.GLTFLoader();
        loader.load(
          meta.src,
          (gltf) => {
            modelRoot.add(gltf.scene);
            // Basic transform; tweak as needed for your assets
            gltf.scene.scale.set(0.5, 0.5, 0.5);
            gltf.scene.position.set(0, 0, 0);
            statusEl.textContent = 'Point your camera at the bullseye marker next to the QR.';
          },
          undefined,
          (error) => {
            console.error('Error loading marker model:', error);
            statusEl.textContent = 'Error loading marker model.';
          }
        );

        function animate() {
          requestAnimationFrame(animate);

          if (arToolkitSource.ready !== false) {
            arToolkitContext.update(arToolkitSource.domElement);
            markerRoot.visible = camera.visible;
          }

          renderer.render(scene, camera);
        }

        animate();
      }

      try {
        initMarkerExample();
      } catch (err) {
        console.error('Marker AR init error:', err);
        statusEl.textContent = 'Marker AR error: ' + (err && err.message ? err.message : String(err));
      }
    </script>
  </body>
</html>
